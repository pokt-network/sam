<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAM - Simple AppStakes Manager</title>
    <script crossorigin="anonymous" src="https://unpkg.com/react@18.3.1/umd/react.production.min.js" integrity="sha384-DGyLxAyjq0f9SPpVevD6IgztCFlnMF6oW/XQGmfe+IsZ8TqEiDrcHkMLKI6fiB/Z"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js" integrity="sha384-gTGxhz21lVGYNMcdJOyq01Edg0jhn/c22nsx0kyqP0TxaV5WVdsSH1fSDUf5YJj1"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone@7.26.5/babel.min.js" integrity="sha384-SF03qAKhbEVbqj7hDewV6mk3wJJyzxf3nBCxNuF46+Sof8f1fx4Pes2gOVItRZn9"></script>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #001B44;
            color: #ffffff;
        }

        .gradient-text {
            background: linear-gradient(135deg, #00D2FF 0%, #3A7BD5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gradient-blue {
            background: linear-gradient(135deg, #00D2FF 0%, #3A7BD5 100%);
        }

        .gradient-yellow {
            background: linear-gradient(135deg, #FFB800 0%, #FF6B00 100%);
        }

        .gradient-card {
            background: linear-gradient(135deg, rgba(0, 210, 255, 0.1) 0%, rgba(58, 123, 213, 0.1) 100%);
            border: 1px solid rgba(0, 210, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00D2FF 0%, #3A7BD5 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(0, 210, 255, 0.5);
            transform: translateY(-2px);
        }

        .status-danger {
            background: linear-gradient(135deg, #FF3B3B 0%, #FF6B00 50%);
        }

        .status-warning {
            background: linear-gradient(135deg, #FFB800 0%, #FF8800 100%);
        }

        .status-good {
            background: linear-gradient(135deg, #00D2A0 0%, #00D2FF 100%);
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useMemo, useCallback } = React;

    const API_BASE_URL = window.location.origin + '/api';

    const api = {
        fetchApplications: async (network, forceRefresh = false) => {
            const url = `${API_BASE_URL}/applications?network=${network}${forceRefresh ? '&refresh=true' : ''}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch applications');
            return response.json();
        },
        fetchApplication: async (address, network) => {
            const response = await fetch(`${API_BASE_URL}/applications/${address}?network=${network}`);
            if (!response.ok) throw new Error('Failed to fetch application');
            return response.json();
        },
        fetchBank: async (network, forceRefresh = false) => {
            const url = `${API_BASE_URL}/bank?network=${network}${forceRefresh ? '&refresh=true' : ''}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch bank account');
            return response.json();
        },
        upstakeApplication: async (address, network, amount) => {
            const response = await fetch(`${API_BASE_URL}/applications/${address}/upstake?network=${network}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
            });
            if (!response.ok) throw new Error('Failed to upstake application');
            return response.json();
        },
        fundApplication: async (address, network, amount) => {
            const response = await fetch(`${API_BASE_URL}/applications/${address}/fund?network=${network}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
            });
            if (!response.ok) throw new Error('Failed to fund application');
            return response.json();
        },
        fetchNetworks: async () => {
            const response = await fetch(`${API_BASE_URL}/networks`);
            if (!response.ok) throw new Error('Failed to fetch networks');
            return response.json();
        },
        fetchConfig: async () => {
            const response = await fetch(`${API_BASE_URL}/config`);
            if (!response.ok) throw new Error('Failed to fetch config');
            return response.json();
        }
    };

    // Icons
    const Search = ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
    );

    const RefreshCw = ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M21 2v6h-6"></path>
            <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
            <path d="M3 22v-6h6"></path>
            <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
        </svg>
    );

    const TrendingUp = ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
            <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
    );

    const DollarSign = ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
    );

    const ChevronDown = ({ size = 16 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    );

    const ChevronUp = ({ size = 16 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
    );

    const Check = ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
    );

    const AlertCircle = ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
    );

    const Loader = ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="animate-spin">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
        </svg>
    );

    // Utilities
    const formatStake = (upokt) => {
        const pokt = upokt / 1000000;
        return pokt.toLocaleString(undefined, { maximumFractionDigits: 2 });
    };

    const getStakeStatus = (stake, thresholds) => {
        const stakeNum = Number(stake || 0);
        const warnNum = Number(thresholds?.warning_threshold || 0);
        const dangerNum = Number(thresholds?.danger_threshold || 0);

        const thresholdsAreInMicro = Math.max(warnNum, dangerNum) > 1e6;
        const stakePokt = stakeNum / 1e6;
        const warningPokt = thresholdsAreInMicro ? warnNum / 1e6 : warnNum;
        const dangerPokt = thresholdsAreInMicro ? dangerNum / 1e6 : dangerNum;

        if (stakePokt <= dangerPokt) return 'danger';
        if (stakePokt <= warningPokt) return 'warning';
        return 'good';
    };

    // Custom Hooks

    const useNotification = () => {
        const [notification, setNotification] = useState(null);
        const timerRef = useRef(null);

        const showNotification = useCallback((message, type = 'success') => {
            if (timerRef.current) clearTimeout(timerRef.current);
            setNotification({ message, type });
            timerRef.current = setTimeout(() => setNotification(null), 5000);
        }, []);

        return { notification, showNotification };
    };

    const useApplications = (network, thresholds, showNotification) => {
        const [apps, setApps] = useState([]);
        const [loading, setLoading] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const [sortField, setSortField] = useState('stake');
        const [sortDirection, setSortDirection] = useState('asc');

        const filteredApps = useMemo(() => {
            const filtered = apps.filter(app =>
                app.address.toLowerCase().includes(searchTerm.toLowerCase()) ||
                app.service_id?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            filtered.sort((a, b) => {
                let aVal, bVal;
                switch (sortField) {
                    case 'address':
                        aVal = a.address.toLowerCase();
                        bVal = b.address.toLowerCase();
                        break;
                    case 'service_id':
                        aVal = (a.service_id || '').toLowerCase();
                        bVal = (b.service_id || '').toLowerCase();
                        break;
                    case 'stake':
                        aVal = a.stake;
                        bVal = b.stake;
                        break;
                    case 'status':
                        aVal = getStakeStatus(a.stake, thresholds);
                        bVal = getStakeStatus(b.stake, thresholds);
                        break;
                    default:
                        return 0;
                }
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            return filtered;
        }, [apps, searchTerm, sortField, sortDirection, thresholds]);

        const loadApplications = useCallback(async (net, showLoader = true) => {
            if (showLoader) setLoading(true);
            try {
                const data = await api.fetchApplications(net);
                setApps(data || []);
            } catch (error) {
                showNotification(`Failed to load applications: ${error.message}`, 'error');
                setApps([]);
            } finally {
                if (showLoader) setLoading(false);
            }
        }, [showNotification]);

        const handleSort = useCallback((field) => {
            if (sortField === field) {
                setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc');
            } else {
                setSortField(field);
                setSortDirection('desc');
            }
        }, [sortField]);

        return {
            apps, setApps, filteredApps, loading, setLoading,
            searchTerm, setSearchTerm, sortField, sortDirection,
            handleSort, loadApplications
        };
    };

    const useBank = (showNotification) => {
        const [bankAccount, setBankAccount] = useState(null);

        const loadBankAccount = useCallback(async (network) => {
            try {
                const data = await api.fetchBank(network);
                setBankAccount(data);
            } catch (error) {
                console.error(`Failed to load bank: ${error.message}`);
            }
        }, []);

        return { bankAccount, setBankAccount, loadBankAccount };
    };

    const useAutoRefresh = (callback, network) => {
        const [autoRefreshEnabled, setAutoRefreshEnabled] = useState(false);
        const callbackRef = useRef(callback);
        callbackRef.current = callback;

        useEffect(() => {
            if (!autoRefreshEnabled) return;
            const interval = setInterval(() => callbackRef.current(), 60000);
            return () => clearInterval(interval);
        }, [autoRefreshEnabled]);

        const toggleAutoRefresh = useCallback(() => {
            setAutoRefreshEnabled(prev => !prev);
        }, []);

        return { autoRefreshEnabled, toggleAutoRefresh };
    };

    const useKeyboardShortcuts = (handlers) => {
        const handlersRef = useRef(handlers);
        handlersRef.current = handlers;

        useEffect(() => {
            const handleKeyPress = (e) => {
                if (e.target.tagName === 'INPUT') return;
                const handler = handlersRef.current[e.key.toLowerCase()];
                if (handler) handler();
            };
            window.addEventListener('keypress', handleKeyPress);
            return () => window.removeEventListener('keypress', handleKeyPress);
        }, []);
    };

    // ErrorBoundary
    class ErrorBoundary extends React.Component {
        constructor(props) {
            super(props);
            this.state = { hasError: false, error: null };
        }

        static getDerivedStateFromError(error) {
            return { hasError: true, error };
        }

        componentDidCatch(error, errorInfo) {
            console.error('ErrorBoundary caught:', error, errorInfo);
        }

        render() {
            if (this.state.hasError) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{background: 'linear-gradient(180deg, #001B44 0%, #002855 100%)'}}>
                        <div className="glass-card rounded-2xl p-8 max-w-md w-full text-center">
                            <h2 className="text-2xl font-black gradient-text mb-4">Something went wrong</h2>
                            <p className="text-white/60 mb-6">{this.state.error?.message || 'An unexpected error occurred'}</p>
                            <button
                                onClick={() => window.location.reload()}
                                className="px-6 py-3 btn-primary rounded-xl font-bold text-white"
                            >
                                Reload
                            </button>
                        </div>
                    </div>
                );
            }
            return this.props.children;
        }
    }

    // Header Component
    const Header = ({ currentNetwork, onRefresh, loading, autoRefreshEnabled, onToggleAutoRefresh, onNetworkClick }) => (
        <div className="glass-card border-b border-white/10">
            <div className="max-w-8xl mx-auto px-6 py-6">
                <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-4">
                        <h1 className="text-4xl font-black gradient-text">SAM</h1>
                        <span className="px-3 py-1 glass-card rounded-full text-sm font-medium">
                            {currentNetwork}
                        </span>
                        {autoRefreshEnabled && (
                            <span className="px-3 py-1 gradient-blue rounded-full text-sm font-medium flex items-center gap-2">
                                <RefreshCw size={14} className="animate-spin" />
                                Auto
                            </span>
                        )}
                    </div>
                    <div className="flex items-center gap-3">
                        <button
                            onClick={onToggleAutoRefresh}
                            className={`px-4 py-2 rounded-lg font-medium transition-all ${
                                autoRefreshEnabled ? 'btn-primary' : 'glass-card hover:bg-white/5'
                            }`}
                        >
                            Auto {autoRefreshEnabled ? 'ON' : 'OFF'}
                        </button>
                        <button
                            onClick={onRefresh}
                            disabled={loading}
                            className="px-4 py-2 glass-card hover:bg-white/5 rounded-lg font-medium transition-all flex items-center gap-2 disabled:opacity-50"
                        >
                            {loading ? <Loader size={16} /> : <RefreshCw size={16} />}
                            Refresh (r)
                        </button>
                        <button
                            onClick={onNetworkClick}
                            className="px-4 py-2 glass-card hover:bg-white/5 rounded-lg font-medium transition-all"
                        >
                            Network (n)
                        </button>
                    </div>
                </div>
                <p className="text-white/60 text-lg">Simple AppStakes Manager</p>
            </div>
        </div>
    );

    // Stats Panel
    const StatsPanel = ({ apps, thresholds, bankAccount }) => {
        const totalStake = apps.reduce((sum, app) => sum + app.stake, 0);
        const totalLiquid = apps.reduce((sum, app) => sum + app.liquid_balance, 0);
        const lowStakeCount = apps.filter(app => getStakeStatus(app.stake, thresholds) === 'danger').length;

        const heroStyle = {
            background: 'radial-gradient(circle, rgba(0, 210, 255, 0.3) 0%, rgba(58, 123, 213, 0.1) 50%, transparent 100%)'
        };

        return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div className="gradient-card rounded-2xl p-6 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-[150px] h-[150px] rounded-full pointer-events-none blur-[40px]" style={heroStyle}></div>
                    <div className="relative z-10">
                        <p className="text-white/60 text-sm font-medium mb-2">Total Applications</p>
                        <p className="text-4xl font-black gradient-text">{apps.length}</p>
                    </div>
                </div>

                <div className="gradient-card rounded-2xl p-6 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-[150px] h-[150px] rounded-full pointer-events-none blur-[40px]" style={heroStyle}></div>
                    <div className="relative z-10">
                        <p className="text-white/60 text-sm font-medium mb-2">Total Stake</p>
                        <p className="text-3xl font-black text-white">{formatStake(totalStake)}</p>
                        <p className="text-white/40 text-xs mt-1">Liquid: {formatStake(totalLiquid)} POKT</p>
                    </div>
                </div>

                <div className="gradient-card rounded-2xl p-6 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-[150px] h-[150px] rounded-full pointer-events-none blur-[40px]" style={heroStyle}></div>
                    <div className="relative z-10">
                        <p className="text-white/60 text-sm font-medium mb-2">Bank Balance</p>
                        <p className="text-3xl font-black text-white">
                            {bankAccount ? formatStake(bankAccount.balance) : '...'}
                        </p>
                        {bankAccount && (
                            <p className="text-white/40 text-xs mt-1 truncate" title={bankAccount.address}>
                                {bankAccount.address.slice(0, 10)}...{bankAccount.address.slice(-6)}
                            </p>
                        )}
                    </div>
                </div>

                <div className="gradient-card rounded-2xl p-6 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-[150px] h-[150px] rounded-full pointer-events-none blur-[40px]" style={heroStyle}></div>
                    <div className="relative z-10">
                        <p className="text-white/60 text-sm font-medium mb-2">Low Stake Apps</p>
                        <p className="text-4xl font-black text-red-400">{lowStakeCount}</p>
                    </div>
                </div>
            </div>
        );
    };

    // Search Bar
    const SearchBar = ({ value, onChange }) => (
        <div className="mb-6">
            <div className="relative">
                <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-white/40">
                    <Search size={20} />
                </div>
                <input
                    type="text"
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    placeholder="Search applications by address or service ID..."
                    className="w-full pl-12 pr-6 py-4 glass-card rounded-xl text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all text-lg"
                />
            </div>
        </div>
    );

    // Sortable Header
    const SortableHeader = ({ children, field, currentField, direction, onSort, align = 'left' }) => {
        const isActive = currentField === field;
        return (
            <th
                className="cursor-pointer select-none transition-all duration-300 hover:bg-[rgba(0,210,255,0.1)] px-6 py-4 text-sm font-semibold text-white/60"
                onClick={() => onSort(field)}
            >
                <div className={`flex items-center gap-2 ${align === 'right' ? 'justify-end' : ''}`}>
                    {children}
                    {isActive && (direction === 'asc' ? <ChevronUp /> : <ChevronDown />)}
                </div>
            </th>
        );
    };

    // Application Row
    const ApplicationRow = ({ app, isSelected, onSelect, onUpstake, onFund, thresholds, operationLoading }) => {
        const status = getStakeStatus(app.stake, thresholds);
        const isUpstaking = operationLoading.type === 'upstake' && operationLoading.address === app.address;
        const isFunding = operationLoading.type === 'fund' && operationLoading.address === app.address;

        return (
            <tr
                onClick={() => onSelect(app.address)}
                className={`border-t border-white/10 cursor-pointer transition-all hover:bg-white/5 ${
                    isSelected ? 'bg-white/10' : ''
                }`}
            >
                <td className="px-6 py-4">
                    <span className="text-sm font-mono text-white/80">{app.address}</span>
                </td>
                <td className="px-6 py-4">
                    <span className="text-sm font-medium text-white">{app.service_id}</span>
                </td>
                <td className="px-6 py-4 text-right">
                    <div className="font-semibold text-white text-base">{formatStake(app.stake)}</div>
                    <div className="text-xs text-white/40">Liquid: {formatStake(app.liquid_balance)}</div>
                </td>
                <td className="px-6 py-4">
                    <span className={`px-3 py-1 rounded-full text-xs font-bold text-white ${
                        status === 'danger' ? 'status-danger' :
                            status === 'warning' ? 'status-warning' : 'status-good'
                    }`}>
                        {status.toUpperCase()}
                    </span>
                </td>
                <td className="px-6 py-4">
                    <span className="text-sm font-mono text-white/60">{app.gateway}</span>
                </td>
                <td className="px-6 py-4">
                    <div className="flex items-center justify-end gap-2">
                        <button
                            onClick={(e) => { e.stopPropagation(); onUpstake(app); }}
                            disabled={isUpstaking}
                            className="p-2 glass-card hover:bg-white/10 rounded-lg transition-all disabled:opacity-50"
                            title="Upstake"
                        >
                            {isUpstaking ? <Loader size={16} /> : <TrendingUp size={16} className="text-green-400" />}
                        </button>
                        <button
                            onClick={(e) => { e.stopPropagation(); onFund(app); }}
                            disabled={isFunding}
                            className="p-2 glass-card hover:bg-white/10 rounded-lg transition-all disabled:opacity-50"
                            title="Fund"
                        >
                            {isFunding ? <Loader size={16} /> : <DollarSign size={16} className="text-blue-400" />}
                        </button>
                    </div>
                </td>
            </tr>
        );
    };

    // Applications Table
    const ApplicationsTable = ({ apps, selectedAddress, onSelect, onUpstake, onFund, thresholds, sortField, sortDirection, onSort, operationLoading }) => (
        <div className="glass-card rounded-2xl overflow-hidden">
            <table className="w-full">
                <thead className="bg-white/5">
                <tr>
                    <SortableHeader field="address" currentField={sortField} direction={sortDirection} onSort={onSort}>
                        Application Address
                    </SortableHeader>
                    <SortableHeader field="service_id" currentField={sortField} direction={sortDirection} onSort={onSort}>
                        Service ID
                    </SortableHeader>
                    <SortableHeader field="stake" currentField={sortField} direction={sortDirection} onSort={onSort} align="right">
                        Stake (POKT)
                    </SortableHeader>
                    <SortableHeader field="status" currentField={sortField} direction={sortDirection} onSort={onSort}>
                        Status
                    </SortableHeader>
                    <th className="px-6 py-4 text-sm font-semibold text-white/60 text-left">Gateway</th>
                    <th className="px-6 py-4 text-sm font-semibold text-white/60 text-right">Actions</th>
                </tr>
                </thead>
                <tbody>
                {apps.length === 0 ? (
                    <tr>
                        <td colSpan="6" className="px-6 py-12 text-center text-white/40">
                            No applications found
                        </td>
                    </tr>
                ) : (
                    apps.map((app) => (
                        <ApplicationRow
                            key={app.address}
                            app={app}
                            isSelected={selectedAddress === app.address}
                            onSelect={onSelect}
                            onUpstake={onUpstake}
                            onFund={onFund}
                            thresholds={thresholds}
                            operationLoading={operationLoading}
                        />
                    ))
                )}
                </tbody>
            </table>
        </div>
    );

    // Amount Input Modal (replaces prompt() + ConfirmationModal)
    const AmountInputModal = ({ isOpen, onClose, onConfirm, title, message, action, actionLoading }) => {
        const [amount, setAmount] = useState('');
        const inputRef = useRef(null);

        useEffect(() => {
            if (isOpen) {
                setAmount('');
                setTimeout(() => inputRef.current?.focus(), 50);
            }
        }, [isOpen]);

        useEffect(() => {
            if (!isOpen) return;
            const handleKeyDown = (e) => {
                if (e.key === 'Escape') onClose();
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
        }, [isOpen, onClose]);

        if (!isOpen) return null;

        const numericAmount = parseFloat(amount);
        const isValid = !isNaN(numericAmount) && numericAmount > 0;

        const handleSubmit = (e) => {
            e.preventDefault();
            if (isValid && !actionLoading) onConfirm(numericAmount);
        };

        return (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
                <div className="glass-card rounded-2xl p-8 max-w-md w-full border-2 border-white/20" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-2xl font-black gradient-text mb-4">{title}</h2>
                    <p className="text-white/80 mb-6">{message}</p>
                    <form onSubmit={handleSubmit}>
                        <div className="mb-6">
                            <label className="block text-sm text-white/60 mb-2">Amount (POKT)</label>
                            <input
                                ref={inputRef}
                                type="number"
                                step="any"
                                min="0"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="Enter amount..."
                                className="w-full px-4 py-3 glass-card rounded-xl text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all text-lg"
                            />
                        </div>
                        {isValid && (
                            <div className="gradient-card rounded-xl p-4 mb-6">
                                <p className="text-sm text-white/60 mb-1">Amount</p>
                                <p className="text-3xl font-black text-white">{numericAmount} POKT</p>
                            </div>
                        )}
                        <div className="flex gap-3">
                            <button
                                type="submit"
                                disabled={!isValid || actionLoading}
                                className="flex-1 px-6 py-3 btn-primary rounded-xl font-bold text-white disabled:opacity-50 flex items-center justify-center gap-2"
                            >
                                {actionLoading && <Loader size={16} />}
                                Confirm {action}
                            </button>
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 px-6 py-3 glass-card hover:bg-white/10 rounded-xl font-bold transition-all"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };

    // Network Selector Modal (replaces prompt())
    const NetworkSelectorModal = ({ isOpen, onClose, networks, currentNetwork, onSelect }) => {
        useEffect(() => {
            if (!isOpen) return;
            const handleKeyDown = (e) => {
                if (e.key === 'Escape') onClose();
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
        }, [isOpen, onClose]);

        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
                <div className="glass-card rounded-2xl p-8 max-w-md w-full border-2 border-white/20" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-2xl font-black gradient-text mb-6">Select Network</h2>
                    <div className="flex flex-col gap-3">
                        {networks.map((network) => (
                            <button
                                key={network}
                                onClick={() => { onSelect(network); onClose(); }}
                                className={`px-6 py-4 rounded-xl font-medium text-left transition-all ${
                                    network === currentNetwork
                                        ? 'btn-primary text-white'
                                        : 'glass-card hover:bg-white/10 text-white/80'
                                }`}
                            >
                                {network}
                                {network === currentNetwork && <span className="ml-2 text-sm opacity-80">(current)</span>}
                            </button>
                        ))}
                    </div>
                </div>
            </div>
        );
    };

    // Notification
    const Notification = ({ message, type }) => (
        <div className="fixed bottom-6 right-6 z-50 max-w-md">
            <div className={`flex items-start gap-3 px-6 py-4 rounded-xl shadow-2xl ${
                type === 'success' ? 'gradient-blue' :
                type === 'error' ? 'gradient-yellow' : 'glass-card'
            }`}>
                {type === 'success' ? <Check size={20} /> : <AlertCircle size={20} />}
                <span className="text-sm font-medium">{message}</span>
            </div>
        </div>
    );

    // Main App
    const SAM = () => {
        const [currentNetwork, setCurrentNetwork] = useState('pocket');
        const [availableNetworks, setAvailableNetworks] = useState(['pocket']);
        const [selectedAddress, setSelectedAddress] = useState(null);
        const [operationLoading, setOperationLoading] = useState({ type: null, address: null });
        const [amountModal, setAmountModal] = useState({ isOpen: false });
        const [networkModalOpen, setNetworkModalOpen] = useState(false);
        const [thresholds, setThresholds] = useState({
            warning_threshold: 4500000000,
            danger_threshold: 1000000000
        });

        const { notification, showNotification } = useNotification();
        const {
            apps, setApps, filteredApps, loading, setLoading,
            searchTerm, setSearchTerm, sortField, sortDirection,
            handleSort, loadApplications
        } = useApplications(currentNetwork, thresholds, showNotification);
        const { bankAccount, setBankAccount, loadBankAccount } = useBank(showNotification);

        const { autoRefreshEnabled, toggleAutoRefresh } = useAutoRefresh(() => {
            loadApplications(currentNetwork, false);
            loadBankAccount(currentNetwork);
        }, currentNetwork);

        useEffect(() => {
            const loadInitialData = async () => {
                try {
                    const [networks, config] = await Promise.all([
                        api.fetchNetworks(),
                        api.fetchConfig()
                    ]);
                    setAvailableNetworks(networks);
                    if (config && config.thresholds && typeof config.thresholds === 'object') {
                        setThresholds(prev => ({ ...prev, ...config.thresholds }));
                    } else {
                        console.info('Config thresholds missing or invalid:', config && config.thresholds);
                    }
                    await loadApplications(currentNetwork);
                    await loadBankAccount(currentNetwork);
                } catch (error) {
                    showNotification(`Failed to load data: ${error.message}`, 'error');
                }
            };
            loadInitialData();
        }, []);

        const handleRefresh = useCallback(async () => {
            setLoading(true);
            try {
                const [appsData, bankData] = await Promise.all([
                    api.fetchApplications(currentNetwork, true),
                    api.fetchBank(currentNetwork, true)
                ]);
                setApps(appsData || []);
                setBankAccount(bankData);
                showNotification('Data refreshed successfully');
            } catch (error) {
                showNotification(`Failed to refresh: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }, [currentNetwork, showNotification, setLoading, setApps, setBankAccount]);

        const handleNetworkSelect = useCallback(async (network) => {
            if (network === currentNetwork) return;
            setCurrentNetwork(network);
            await Promise.all([loadApplications(network), loadBankAccount(network)]);
            showNotification(`Switched to ${network}`);
        }, [currentNetwork, loadApplications, loadBankAccount, showNotification]);

        useKeyboardShortcuts({
            r: handleRefresh,
            n: () => setNetworkModalOpen(true),
        });

        const handleUpstake = useCallback((app) => {
            setAmountModal({
                isOpen: true,
                title: 'Upstake Application',
                message: `Upstake ${app.address}?`,
                action: 'Upstake',
                app,
                type: 'upstake',
            });
        }, []);

        const handleFund = useCallback((app) => {
            setAmountModal({
                isOpen: true,
                title: 'Fund Application',
                message: `Fund ${app.address}?`,
                action: 'Fund',
                app,
                type: 'fund',
            });
        }, []);

        const handleAmountConfirm = useCallback(async (amount) => {
            const { app, type } = amountModal;
            setOperationLoading({ type, address: app.address });
            try {
                const apiFn = type === 'upstake' ? api.upstakeApplication : api.fundApplication;
                const result = await apiFn(app.address, currentNetwork, amount);
                const label = type === 'upstake' ? 'Upstaked' : 'Funded';
                showNotification(`${label} ${amount} POKT. TX: ${result.tx_hash || 'submitted'}`);
                setAmountModal({ isOpen: false });
                await Promise.all([loadApplications(currentNetwork), loadBankAccount(currentNetwork)]);
            } catch (error) {
                const label = type === 'upstake' ? 'Upstake' : 'Fund';
                showNotification(`${label} failed: ${error.message}`, 'error');
                setAmountModal({ isOpen: false });
            } finally {
                setOperationLoading({ type: null, address: null });
            }
        }, [amountModal, currentNetwork, showNotification, loadApplications, loadBankAccount]);

        const handleSelectAddress = useCallback((address) => {
            setSelectedAddress(prev => prev === address ? null : address);
        }, []);

        return (
            <div className="min-h-screen" style={{background: 'linear-gradient(180deg, #001B44 0%, #002855 100%)'}}>
                <Header
                    currentNetwork={currentNetwork}
                    onRefresh={handleRefresh}
                    loading={loading}
                    autoRefreshEnabled={autoRefreshEnabled}
                    onToggleAutoRefresh={toggleAutoRefresh}
                    onNetworkClick={() => setNetworkModalOpen(true)}
                />

                <div className="max-w-8xl mx-auto px-6 py-8">
                    <StatsPanel apps={filteredApps} thresholds={thresholds} bankAccount={bankAccount} />
                    <SearchBar value={searchTerm} onChange={setSearchTerm} />
                    <ApplicationsTable
                        apps={filteredApps}
                        selectedAddress={selectedAddress}
                        onSelect={handleSelectAddress}
                        onUpstake={handleUpstake}
                        onFund={handleFund}
                        thresholds={thresholds}
                        sortField={sortField}
                        sortDirection={sortDirection}
                        onSort={handleSort}
                        operationLoading={operationLoading}
                    />

                    <div className="mt-6 glass-card rounded-xl p-4">
                        <div className="text-sm text-white/60">
                            <span className="font-semibold text-white/80">Keyboard Shortcuts:</span>{' '}
                            <kbd className="px-2 py-1 bg-white/10 rounded text-xs font-mono">r</kbd> Refresh{' '}
                            <kbd className="px-2 py-1 bg-white/10 rounded text-xs font-mono">n</kbd> Network{' '}
                            <span className="ml-4">Connected to: <span className="text-cyan-400">{API_BASE_URL}</span></span>
                        </div>
                    </div>
                </div>

                <AmountInputModal
                    isOpen={amountModal.isOpen}
                    onClose={() => setAmountModal({ isOpen: false })}
                    onConfirm={handleAmountConfirm}
                    title={amountModal.title}
                    message={amountModal.message}
                    action={amountModal.action}
                    actionLoading={operationLoading.type !== null}
                />

                <NetworkSelectorModal
                    isOpen={networkModalOpen}
                    onClose={() => setNetworkModalOpen(false)}
                    networks={availableNetworks}
                    currentNetwork={currentNetwork}
                    onSelect={handleNetworkSelect}
                />

                {notification && (
                    <Notification message={notification.message} type={notification.type} />
                )}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ErrorBoundary><SAM /></ErrorBoundary>);
</script>
</body>
</html>
